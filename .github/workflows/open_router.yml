name: Open Router Credit Check

on:
  workflow_dispatch:
  schedule:
    - cron: "5/30 * * * *" # run every 30 minutes, starting at 5 past the hour

jobs:
  credit_remaining:
    runs-on: ubuntu-latest
    steps:
      - id: get_limit_remaining
        env:
          OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}
        run: |
          echo "LIMIT_REMAINING=$(curl "https://openrouter.ai/api/v1/key" -H "Authorization: Bearer $OPEN_ROUTER_API_KEY" | jq -c '.data.limit_remaining')" >> $GITHUB_ENV
      - id: set_summary
        run: |
          echo "\$${{ env.LIMIT_REMAINING }}" >> $GITHUB_STEP_SUMMARY
      - id: low_credit_alert
        if: ${{ env.LIMIT_REMAINING != '' && fromJSON(env.LIMIT_REMAINING) < 30.0 }}
        run: |
          exit 1
